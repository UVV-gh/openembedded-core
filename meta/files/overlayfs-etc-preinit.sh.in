#!/bin/sh

PATH=/sbin:/bin:/usr/sbin:/usr/bin
overlay_mount() {
    overlayfs_mount_point=$1
    overlayfs_suffix=$2
    overlayfs_fstype=$3
    overlayfs_device=$4
    overlayfs_mount_options=$5
    overlayfs_params=$6
    fail_message=$7

    overlayfs_upper_dir=$overlayfs_mount_point/$overlayfs_suffix/upper
    overlayfs_work_dir=$overlayfs_mount_point/$overlayfs_suffix/work

    mount -o remount,rw /

    mkdir -p /proc
    mkdir -p /sys
    mkdir -p /run
    mkdir -p /var/run

    mount -t proc proc /proc
    mount -t sysfs sysfs /sys

    [ -z "$CONSOLE" ] && CONSOLE="/dev/console"

    mkdir -p $overlayfs_mount_point

    if mount -n -t $overlayfs_fstype -o $overlayfs_mount_options $overlayfs_device $overlayfs_mount_point
    then
        mkdir -p $overlayfs_upper_dir
        mkdir -p $overlayfs_work_dir
        mount -n -t overlay -o upperdir=$overlayfs_upper_dir,lowerdir=/etc,workdir=$overlayfs_work_dir $overlayfs_mount_point/overlay-etc/upper /etc || echo "PREINIT: Mounting etc-overlay failed!"
    else
        fail_message
    fi
}
